- content_for :page_title do
  = t('admin.gamepatch.analytics.dialogues_title')

- content_for :heading_actions do
  = form_tag admin_gamepatch_dialogues_analytics_index_path, method: :get, class: 'simple_form' do
    .fields-row
      .fields-row__column
        = date_field_tag :start_date, params[:start_date] || 30.days.ago.to_date
      .fields-row__column
        = date_field_tag :end_date, params[:end_date] || Date.current
      .fields-row__column
        = button_tag t('admin.gamepatch.analytics.apply'), type: 'submit', class: 'button'

- if @dialogue_funnels.empty?
  %p.hint= t('admin.gamepatch.analytics.no_dialogues')
- else
  - @dialogue_funnels.each do |funnel|
    .batch-table__wrapper
      %h4
        = t('admin.gamepatch.analytics.dialogue')
        %code= funnel[:dialogue_id]

      .dashboard
        .dashboard__item
          .dashboard__quick-access
            %span= t('admin.gamepatch.analytics.started')
            %strong= funnel[:started]

        .dashboard__item
          .dashboard__quick-access
            %span= t('admin.gamepatch.analytics.completed')
            %strong= funnel[:completed]

        .dashboard__item
          .dashboard__quick-access.dashboard__quick-access--yellow
            %span= t('admin.gamepatch.analytics.completion_rate')
            %strong= "#{funnel[:overall_completion_rate]}%"

      .table-wrapper
        %table.table
          %thead
            %tr
              %th #
              %th= t('admin.gamepatch.analytics.step')
              %th= t('admin.gamepatch.widgets.type')
              %th= t('admin.gamepatch.analytics.impressions')
              %th= t('admin.gamepatch.analytics.responses')
              %th= t('admin.gamepatch.analytics.rate')
              %th= t('admin.gamepatch.analytics.drop_off')
          %tbody
            - funnel[:steps].each_with_index do |step, idx|
              %tr{ class: step[:is_ending] ? 'positive-hint' : nil }
                %td= idx + 1
                %td
                  = truncate(step[:prompt], length: 40)
                  - if step[:is_ending]
                    %span.indicator-icon.success
                      = material_symbol('check')
                %td= step[:widget_type]
                %td= step[:impressions]
                %td= step[:responses]
                %td= "#{step[:completion_rate]}%"
                %td
                  - if step[:drop_off] > 0
                    %span.negative-hint= "-#{step[:drop_off]}%"

      %hr.spacer
