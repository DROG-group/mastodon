- content_for :page_title do
  = t('admin.gamepatch.payments.title')

- content_for :heading_actions do
  .actions
    = link_to t('admin.gamepatch.payments.view_subscriptions'), admin_gamepatch_payments_subscriptions_path, class: 'button'
    = link_to t('admin.gamepatch.payments.view_payments'), admin_gamepatch_payments_payments_path, class: 'button'

.dashboard
  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--yellow
      %span= t('admin.gamepatch.payments.total_subscriptions')
      %strong= @overview[:total_subscriptions]

  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--positive
      %span= t('admin.gamepatch.payments.active_subscriptions')
      %strong= @overview[:active_subscriptions]

  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--neutral
      %span= t('admin.gamepatch.payments.pending_subscriptions')
      %strong= @overview[:pending_subscriptions]

  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--negative
      %span= t('admin.gamepatch.payments.cancelled_subscriptions')
      %strong= @overview[:cancelled_subscriptions]

%hr.spacer

.dashboard
  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--yellow
      %span= t('admin.gamepatch.payments.total_payments')
      %strong= @overview[:total_payments]

  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--positive
      %span= t('admin.gamepatch.payments.successful_payments')
      %strong= @overview[:successful_payments]

  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--yellow
      %span= t('admin.gamepatch.payments.total_revenue')
      %strong= number_to_currency(@overview[:total_revenue], unit: "\u20AC")

  .dashboard__item
    .dashboard__quick-access.dashboard__quick-access--positive
      %span= t('admin.gamepatch.payments.monthly_revenue')
      %strong= number_to_currency(@overview[:monthly_revenue], unit: "\u20AC")

%hr.spacer

%h3= t('admin.gamepatch.payments.tier_distribution')

.simple_form
  - Gamepatch::MollieService::TIERS.each do |tier, config|
    .batch-table__row
      .batch-table__row__content
        %span.batch-table__row__content__extra
          = config[:badge]
          = config[:name]
        %span.batch-table__row__content__text= @tier_distribution[tier] || 0

%hr.spacer

%h3= t('admin.gamepatch.payments.payment_methods')

.simple_form
  - @payment_method_distribution.each do |method, count|
    .batch-table__row
      .batch-table__row__content
        %span.batch-table__row__content__extra= method || 'Unknown'
        %span.batch-table__row__content__text= count

%hr.spacer

%h3= t('admin.gamepatch.payments.recent_subscriptions')

.table-wrapper
  %table.table
    %thead
      %tr
        %th= t('admin.gamepatch.payments.account')
        %th= t('admin.gamepatch.payments.tier')
        %th= t('admin.gamepatch.payments.status')
        %th= t('admin.gamepatch.payments.amount')
        %th= t('admin.gamepatch.payments.created')
    %tbody
      - @recent_subscriptions.each do |subscription|
        %tr
          %td
            = link_to subscription.account&.username || 'N/A', admin_account_path(subscription.account_id)
          %td
            - tier_config = Gamepatch::MollieService::TIERS[subscription.tier]
            = tier_config&.dig(:badge)
            = subscription.tier.titleize
          %td
            %span.indicator-icon{ class: if subscription.active?
                                           'success'
                                         else
                                           (subscription.cancelled? ? 'failure' : nil)
            end }
            = subscription.status
          %td= number_to_currency(subscription.amount, unit: "\u20AC")
          %td= l(subscription.created_at)

%hr.spacer

%h3= t('admin.gamepatch.payments.recent_payments')

.table-wrapper
  %table.table
    %thead
      %tr
        %th= t('admin.gamepatch.payments.account')
        %th= t('admin.gamepatch.payments.payment_id')
        %th= t('admin.gamepatch.payments.status')
        %th= t('admin.gamepatch.payments.amount')
        %th= t('admin.gamepatch.payments.method')
        %th= t('admin.gamepatch.payments.date')
    %tbody
      - @recent_payments.each do |payment|
        %tr
          %td
            = link_to payment.account&.username || 'N/A', admin_account_path(payment.account_id) if payment.account_id
          %td
            %code= truncate(payment.mollie_payment_id, length: 20)
          %td
            %span.indicator-icon{ class: if payment.paid?
                                           'success'
                                         else
                                           (payment.failed? ? 'failure' : nil)
            end }
            = payment.status
          %td= number_to_currency(payment.amount, unit: "\u20AC")
          %td= payment.payment_method || '-'
          %td= l(payment.created_at)

%hr.spacer

%h3= t('admin.gamepatch.payments.export_data')

.actions
  = link_to t('admin.gamepatch.payments.export_subscriptions'), admin_gamepatch_payments_export_path(export_type: 'subscriptions'), class: 'button button-secondary'
  = link_to t('admin.gamepatch.payments.export_payments'), admin_gamepatch_payments_export_path(export_type: 'payments'), class: 'button button-secondary'
  = link_to t('admin.gamepatch.payments.export_revenue'), admin_gamepatch_payments_export_path(export_type: 'revenue'), class: 'button button-secondary'
